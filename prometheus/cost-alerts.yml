groups:
  - name: cost_alerts
    interval: 5m
    rules:
      - alert: HighDailyCost
        expr: rate(aws_billing_estimated_charges_total[24h]) > 2
        for: 1h
        annotations:
          summary: "High daily AWS cost detected"
          description: "Daily AWS cost is ${{ $value | humanize }}, exceeding $2/day threshold."

      - alert: MonthlyBudgetExceededDev
        expr: rate(aws_billing_estimated_charges_total[30d]) * 30 > 20
        for: 1h
        annotations:
          summary: "Dev environment monthly budget exceeded"
          description: "Projected monthly cost is ${{ $value | humanize }}, exceeding $20 dev budget."

      - alert: MonthlyBudgetExceededProd
        expr: rate(aws_billing_estimated_charges_total[30d]) * 30 > 50
        for: 1h
        annotations:
          summary: "Prod environment monthly budget exceeded"
          description: "Projected monthly cost is ${{ $value | humanize }}, exceeding $50 prod budget."

      - alert: CostSpike
        expr: >
          (rate(aws_billing_estimated_charges_total[1h]) > 1.2 * avg_over_time(rate(aws_billing_estimated_charges_total[1h])[7d:1h]))
        for: 30m
        annotations:
          summary: "Cost spike detected"
          description: "AWS cost has spiked more than 20% above 7-day average."

      - alert: MonthlyBudgetWarningDev
        expr: rate(aws_billing_estimated_charges_total[30d]) * 30 > 16
        for: 2h
        annotations:
          summary: "Dev environment approaching monthly budget"
          description: "Projected monthly cost is ${{ $value | humanize }}, at 80% of $20 dev budget."

      - alert: MonthlyBudgetWarningProd
        expr: rate(aws_billing_estimated_charges_total[30d]) * 30 > 40
        for: 2h
        annotations:
          summary: "Prod environment approaching monthly budget"
          description: "Projected monthly cost is ${{ $value | humanize }}, at 80% of $50 prod budget."

      - alert: CostExporterDown
        expr: up{job="cost-exporter"} == 0
        for: 10m
        annotations:
          summary: "Cost exporter is down"
          description: "Cost exporter has been unreachable for 10 minutes."

      - alert: CostDataStale
        expr: time() - timestamp(aws_billing_estimated_charges_total) > 7200
        for: 5m
        annotations:
          summary: "Cost data is stale"
          description: "Cost data has not been updated for more than 2 hours."

  - name: cost_optimization
    interval: 1h
    rules:
      - alert: HighServiceCost
        expr: >
          topk(5, sum by (service) (rate(aws_billing_service_charges_total[24h]))) > 10
        for: 1h
        annotations:
          summary: "High cost for service: {{ $labels.service }}"
          description: "Service {{ $labels.service }} has cost ${{ $value | humanize }}/month (>$10)."
