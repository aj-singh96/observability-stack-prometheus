groups:
  - name: system_alerts
    interval: 30s
    rules:
      - alert: InstanceDown
        expr: up{job!="alertmanager"} == 0
        for: 5m
        annotations:
          summary: "Instance {{ $labels.instance }} is down"
          description: "{{ $labels.instance }} of job {{ $labels.job }} has been down for 5+ minutes."

      - alert: HighCPUUsage
        expr: (100 - (avg by (instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)) > 80
        for: 5m
        annotations:
          summary: "High CPU usage on {{ $labels.instance }}"
          description: "CPU usage is {{ $value | humanize }}% (threshold: > 80%)"

      - alert: HighMemoryUsage
        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) > 0.85
        for: 5m
        annotations:
          summary: "High memory usage on {{ $labels.instance }}"
          description: "Memory usage is {{ $value | humanizePercentage }} (threshold: > 85%)"

      - alert: DiskSpaceLow
        expr: (node_filesystem_avail_bytes{fstype!~"tmpfs|fuse.lxcfs"} / node_filesystem_size_bytes) < 0.15
        for: 5m
        annotations:
          summary: "Low disk space on {{ $labels.instance }}"
          description: "Available disk space is {{ $value | humanizePercentage }} (threshold: < 15%)"

      - alert: DiskSpaceCritical
        expr: (node_filesystem_avail_bytes{fstype!~"tmpfs|fuse.lxcfs"} / node_filesystem_size_bytes) < 0.10
        for: 2m
        annotations:
          summary: "Critical disk space on {{ $labels.instance }}"
          description: "Available disk space is {{ $value | humanizePercentage }} (threshold: < 10%)"

      - alert: HighDiskIO
        expr: rate(node_disk_io_time_seconds_total[5m]) > 0.8
        for: 5m
        annotations:
          summary: "High disk I/O on {{ $labels.instance }}"
          description: "Disk I/O time is {{ $value | humanize }}s (threshold: > 0.8)"

      - alert: NetworkErrors
        expr: rate(node_network_transmit_errs_total[5m]) + rate(node_network_receive_errs_total[5m]) > 0
        for: 5m
        annotations:
          summary: "Network errors on {{ $labels.instance }}"
          description: "Network error rate is {{ $value | humanize }} errors/sec"

  - name: prometheus_alerts
    interval: 30s
    rules:
      - alert: PrometheusConfigReloadFailed
        expr: prometheus_config_last_reload_successful == 0
        for: 5m
        annotations:
          summary: "Prometheus configuration reload failed"
          description: "Prometheus failed to reload configuration at {{ $value | formatTime }}"

      - alert: PrometheusTooManyRestarts
        expr: changes(prometheus_tsdb_startups_total[15m]) > 2
        for: 5m
        annotations:
          summary: "Prometheus has restarted too many times"
          description: "Prometheus has restarted {{ $value | humanize }} times in 15 minutes"

      - alert: AlertmanagerDown
        expr: up{job="alertmanager"} == 0
        for: 5m
        annotations:
          summary: "AlertManager is down"
          description: "AlertManager instance has been down for 5+ minutes"
